<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xyz — Sui Purchases</title>
  <meta name="description" content="Sui purchases — Kaplan Asset Holdings." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4faff; --text:#003e6b; --muted:#4d6a88;
      --sui-blue:#00baff; --ring:rgba(0,186,255,.25);
      --topbar-bg:#0b2a45; --topbar-text:#ffffff;
      --glow-strength:0.55; --divider:#d5e7f2;
      --nav-pill:#073055; --nav-pill-active:#0d3c68;
      --row-alt:#f1f7fb; --card:#ffffff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      position:relative; overflow-x:hidden;
    }

    /* Ambient glow */
    body::before{
      content:""; position:fixed; top:-120px; right:-120px; width:520px; height:520px; pointer-events:none;
      background:
        radial-gradient(40% 40% at 70% 30%, rgba(56,232,255,.65) 0%, rgba(56,232,255,0) 70%),
        radial-gradient(55% 55% at 35% 65%, rgba(106,108,255,.55) 0%, rgba(106,108,255,0) 70%);
      filter:blur(40px) saturate(120%); opacity:var(--glow-strength); z-index:0;
    }

    /* Header + Nav */
    .topbar{width:100%; background:var(--topbar-bg); color:var(--topbar-text); position:relative; z-index:1}
    .topbar .inner{max-width:1200px; margin:0 auto; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{font-weight:700; font-size:1rem; letter-spacing:.2px}
    .nav{display:flex; gap:6px; flex-wrap:wrap}
    .nav a{
      color:#d8e7f7; text-decoration:none; font-weight:600; font-size:.9rem;
      padding:8px 12px; border-radius:999px; background:var(--nav-pill); border:1px solid rgba(255,255,255,.08)
    }
    .nav a:hover{background:var(--nav-pill-active)}
    .nav a.active{background:#128dd6; border-color:transparent; color:#fff}

    /* Page */
    .container{max-width:1200px; margin:0 auto; padding:48px 24px}
    h1{font-size:1.6rem; font-weight:800; margin-bottom:10px}
    p.sub{color:var(--muted); margin-bottom:20px}

    /* Summary (like Strategy top band) */
    .summary{
      display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
      margin-bottom:20px;
    }
    .sum-card{
      background:var(--card); border:1px solid var(--divider); border-radius:12px;
      padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.05);
      display:flex; flex-direction:column; align-items:flex-start;
    }
    .sum-label{color:var(--muted); font-size:.85rem; font-weight:700; text-transform:uppercase; letter-spacing:.02em; margin-bottom:6px}
    .sum-value{color:var(--sui-blue); font-weight:800; font-size:1.6rem; line-height:1}

    /* Table */
    .table-wrap{width:100%; overflow:auto; border:1px solid var(--divider); border-radius:12px; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.05)}
    table{width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums}
    thead th{
      text-align:left; font-size:.85rem; letter-spacing:.02em; color:var(--muted); font-weight:700;
      padding:14px 16px; background:#eef6fb; border-bottom:1px solid var(--divider); white-space:nowrap
    }
    tbody td{
      padding:14px 16px; border-bottom:1px solid var(--divider); vertical-align:middle; white-space:nowrap
    }
    tbody tr:nth-child(odd){background:var(--row-alt)}
    tbody tr:last-child td{border-bottom:none}
    .num{color:var(--sui-blue); font-weight:800}

    .legend{margin:14px 2px 0; color:var(--muted); font-size:.85rem}

    @media (max-width:900px){
      .summary{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:600px){
      .summary{grid-template-columns:1fr}
      thead th,tbody td{padding:12px}
      .container{padding:32px 16px}
      .sum-value{font-size:1.4rem}
      .legend{font-size:.8rem}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="inner">
      <div class="brand">Kaplan Asset Holdings</div>
      <nav class="nav">
        <a href="index.html">Overview</a>
        <a class="active" href="purchases.html">Purchases</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <h1>Purchases</h1>
    <p class="sub">Only SUI acquisitions are shown (no deposits/sells). BTC swaps are valued in GBP using historical prices at the time of trade.</p>

    <!-- Summary band -->
    <div class="summary">
      <div class="sum-card">
        <div class="sum-label">SUI Acquired</div>
        <div class="sum-value" id="sum-sui">—</div>
      </div>
      <div class="sum-card">
        <div class="sum-label">Avg SUI Cost (GBP)</div>
        <div class="sum-value" id="sum-avg">—</div>
      </div>
      <div class="sum-card">
        <div class="sum-label">Acq Cost (£)</div>
        <div class="sum-value" id="sum-cost">—</div>
      </div>
      <div class="sum-card">
        <div class="sum-label">SUI Holdings</div>
        <div class="sum-value" id="sum-holdings">—</div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="purchases">
        <thead>
          <tr>
            <th>Count</th>
            <th>Reported</th>
            <th>SUI Acquired</th>
            <th>Avg SUI Cost (GBP)</th>
            <th>Acq Cost (£)</th>
            <th>SUI Holdings</th>
          </tr>
        </thead>
        <tbody><!-- rows injected by JS --></tbody>
      </table>
    </div>

    <p class="legend">Avg cost is weighted: Σ(Acq Cost) ÷ Σ(SUI Acquired). Historical GBP prices fetched from CoinGecko.</p>
  </div>

  <script>
  (async function(){
    // ====== EDIT THESE TRADES ======
    // type: 'GBP_BUY' (SUI/GBP) or 'BTC_SWAP' (SUI/BTC)
    // Required: date, type, suiAmount
    // Optional for GBP_BUY: acqCostGBP, feeGBP
    // Optional for BTC_SWAP: btcAmount (if known), feeGBP
    const TRADES = [
      { date: "2025-10-22T11:02:00Z", type: "GBP_BUY",  suiAmount: 823.8576, acqCostGBP: 1500.05, feeGBP: 5.27 },
      { date: "2025-10-21T02:53:00Z", type: "BTC_SWAP", suiAmount: 1.0512,   feeGBP: 0.00 },                      // no btcAmount → priced via SUI GBP
      { date: "2025-10-20T12:12:00Z", type: "GBP_BUY",  suiAmount: 1290.562, acqCostGBP: 2536.55, feeGBP: 8.91 },
      { date: "2025-10-10T22:45:00Z", type: "BTC_SWAP", suiAmount: 310.9235, btcAmount: 0.00337, feeGBP: 2.05 }, // if you know BTC used
      { date: "2025-10-07T23:57:00Z", type: "GBP_BUY",  suiAmount: 752.561,  acqCostGBP: 1992.99, feeGBP: 7.00 },
    ];
    // ================================

    // Build price range for efficiency
    const toTs = d => Math.floor(new Date(d).getTime()/1000);
    const minTs = Math.min(...TRADES.map(t=>toTs(t.date))) - 86400;
    const maxTs = Math.max(...TRADES.map(t=>toTs(t.date))) + 86400;

    async function rangeFn(id){
      const url = `https://api.coingecko.com/api/v3/coins/${id}/market_chart/range?vs_currency=gbp&from=${minTs}&to=${maxTs}`;
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok) throw new Error("Price fetch failed: "+id);
      const data = await res.json();
      const arr = data.prices || [];
      return (ts)=>{
        const ms = ts*1000;
        let best = arr[0], bestD = best ? Math.abs(arr[0][0]-ms) : Infinity;
        for(const p of arr){ const d = Math.abs(p[0]-ms); if(d < bestD){ best=p; bestD=d; } }
        return best ? best[1] : NaN;
      };
    }

    let suiAt, btcAt;
    try{
      [suiAt, btcAt] = await Promise.all([rangeFn("sui"), rangeFn("bitcoin")]);
    }catch(e){
      console.error(e); alert("Could not load historical prices. Please refresh.");
      return;
    }

    // Build table rows (newest first)
    const tbody = document.querySelector("#purchases tbody");
    const nf0 = new Intl.NumberFormat("en-GB",{maximumFractionDigits:0});
    const nf2 = new Intl.NumberFormat("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2});

    TRADES.sort((a,b)=> new Date(b.date) - new Date(a.date));

    let runningHoldings = 0;
    let totalSui = 0, totalCost = 0;

    const rows = TRADES.map((t, idx)=>{
      const ts = toTs(t.date);
      const suiAmt = +t.suiAmount || 0;
      const fee = +t.feeGBP || 0;

      let acqCost; // in GBP
      if(t.type === "GBP_BUY"){
        acqCost = (typeof t.acqCostGBP === "number") ? (+t.acqCostGBP + fee) : (suiAt(ts)*suiAmt + fee);
      }else{ // BTC_SWAP
        if(typeof t.btcAmount === "number"){
          acqCost = btcAt(ts) * (+t.btcAmount || 0) + fee;
        }else{
          acqCost = suiAt(ts) * suiAmt + fee;
        }
      }

      const avgCost = suiAmt > 0 ? acqCost / suiAmt : NaN;

      // running + totals
      runningHoldings += suiAmt;
      totalSui += suiAmt;
      totalCost += acqCost;

      const count = TRADES.length - idx;
      const reported = new Date(t.date).toLocaleString("en-GB",{dateStyle:"medium", timeStyle:"short"});

      return `
        <tr>
          <td>${count}</td>
          <td>${escapeHtml(reported)}</td>
          <td class="num">${suiAmt ? nf2.format(suiAmt) : "—"}</td>
          <td class="num">${isFinite(avgCost) ? "£"+nf2.format(avgCost) : "—"}</td>
          <td class="num">£${nf2.format(acqCost)}</td>
          <td class="num">${nf0.format(runningHoldings)}</td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join("");

    // Summary band
    const weightedAvg = totalSui > 0 ? (totalCost / totalSui) : NaN;
    document.getElementById("sum-sui").textContent = totalSui ? nf2.format(totalSui) : "—";
    document.getElementById("sum-avg").textContent = isFinite(weightedAvg) ? "£"+nf2.format(weightedAvg) : "—";
    document.getElementById("sum-cost").textContent = "£"+nf2.format(totalCost);
    document.getElementById("sum-holdings").textContent = nf0.format(runningHoldings);

    function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  })();
  </script>
</body>
</html>
