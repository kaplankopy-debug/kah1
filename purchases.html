<script>
(function(){
  /* ====== SIMPLE INPUT (edit only this) ====== */
  const LOTS = [
    ["2025-10-22", 823.8576, 1500.05],
    ["2025-10-21", 1.0512, 2.02],
    ["2025-10-20", 1290.562, 2536.55],
    ["2025-10-10", 310.9235, 584.99],
    ["2025-10-07", 752.561, 1992.99],
  ];
  /* =========================================== */

  const nf0 = new Intl.NumberFormat("en-GB",{maximumFractionDigits:0});
  const nf2 = new Intl.NumberFormat("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2});
  const tbody = document.querySelector("#purchases tbody");

  // sort oldest first to calculate cumulative correctly
  const chronological = LOTS.slice().sort((a,b)=> new Date(a[0]) - new Date(b[0]));

  let runningHoldings = 0;
  let totalSui = 0, totalCost = 0;
  const calculated = [];

  // build holdings correctly in chronological order
  chronological.forEach(row=>{
    const [dateStr, suiAmount, acqCost] = row;
    runningHoldings += suiAmount;
    totalSui += suiAmount;
    totalCost += acqCost;
    calculated.push({
      date: dateStr,
      suiAmount,
      acqCost,
      avgCost: acqCost / suiAmount,
      holdings: runningHoldings
    });
  });

  // now display newest first (for presentation)
  const display = calculated.slice().reverse();
  const weightedAvg = totalSui > 0 ? (totalCost / totalSui) : NaN;

  // summary row (averages + totals)
  const summaryRow = `
    <tr class="summary-row">
      <td>—</td>
      <td>Summary</td>
      <td><span class="num">${nf2.format(totalSui)}</span></td>
      <td><span class="num">£${nf2.format(weightedAvg)}</span></td>
      <td><span class="num">£${nf2.format(totalCost)}</span></td>
      <td><span class="num">${nf0.format(runningHoldings)}</span></td>
    </tr>
  `;

  // detail rows
  const detailRows = display.map((t, idx)=>{
    const count = display.length - idx;
    const reported = new Date(t.date).toLocaleDateString("en-GB",{dateStyle:"medium"});
    return `
      <tr>
        <td>${count}</td>
        <td>${reported}</td>
        <td class="num">${nf2.format(t.suiAmount)}</td>
        <td class="num">£${nf2.format(t.avgCost)}</td>
        <td class="num">£${nf2.format(t.acqCost)}</td>
        <td class="num">${nf0.format(t.holdings)}</td>
      </tr>
    `;
  });

  tbody.innerHTML = summaryRow + detailRows.join("");
})();
</script>
